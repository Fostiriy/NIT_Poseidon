<!DOCTYPE html>

{% macro render_record_card(floor_num, machine_num, client_id, week_days, machine_records, records) %}
    <div class="record_card">
        <p>Этаж {{ floor_num }}</p>
        <p>Машинка {{ machine_num }}</p>
        <table>
            <thead>
            <tr>
                {% set days = ['ПН', 'ВТ', 'СР', 'ЧТ', 'ПТ', 'СБ', 'ВС'] %}
                <th>Время</th>
                {% for i in range(7) %}
                    <th>
                        {{ days[i] }}<br>
                        {{ week_days[i].strftime('%d.%m') }}
                    </th>
                {% endfor %}
            </tr>
            </thead>
            <tbody>
            {% for time, time_records in machine_records.items() %}
                <tr>
                    <td>{{ time }}</td>
                    {% for time_record_index in time_records %}
                        <td>
                            {% set time_record = records.iloc[time_record_index] %}
                            <label>
                                <input type="checkbox"
                                       value="{{ time_record.laundry_registry_id }}"
                                       name="record_cell"
                                       class="record_cell
                                        {% if time_record.is_free == 1 %}
                                       free
                                        {% else %}
                                       disabled
                                        {% endif %}"

                                        {% if time_record.clientele_id == client_id %}
                                       checked
                                        {% elif time_record.is_free == 0 %}
                                       disabled
                                        {% endif %}
                                >
                            </label>
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
{% endmacro %}

{% macro render_record_block(machine_records, client_id, week_days, records) %}
    {% for machine_floor, values in machine_records.items() %}
        {{ render_record_card(machine_floor[0],
                machine_floor[1],
                client_id,
                week_days,
                values,
                records) }}
    {% endfor %}

    <script>
        function checkLimit() {
            if (document.querySelectorAll('.record_cell:checked').length === 3) {
                let recordCells = document.querySelectorAll('.record_cell:not(:checked)');
                recordCells.forEach(recordCell => recordCell.setAttribute('disabled', ''));
            } else {
                let recordCellsFree = document.querySelectorAll('.record_cell.free');
                recordCellsFree.forEach(recordCell => recordCell.removeAttribute('disabled'))
            }
        }

        function cancelRecord() {
            this.checked = true;
            let is_agree = confirm('Отменить запись?')
            if (is_agree) {
                this.name = 'record_cell_to_delete'
                document.querySelector('#record_form').submit()
            }
        }

        document.querySelectorAll('.record_cell').forEach(recordCell => recordCell.addEventListener('change', checkLimit))
        document.querySelectorAll('.record_cell:checked').forEach(recordCell => recordCell.addEventListener('click', cancelRecord))
        checkLimit()
    </script>
{% endmacro %}